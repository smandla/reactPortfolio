"use strict";import I from"events";import R from"node-fetch";var w=class{constructor(){this._table={}}get(i){let e=this._table[i];if(e){if(e.expires>Date.now())return e.value;this.remove(i)}return null}set(i,e,t=6e4){this._table[i]={key:i,value:e,expires:t>0?Date.now()+t:0}}remove(i){delete this._table[i]}clear(){this._table={}}load(i){this._table=JSON.parse(i)}},h=new w,D={default:h};var p="https://leetcode.com",f="https://leetcode-cn.com",m="Mozilla/5.0 LeetCode API";import L from"node-fetch";function d(a){return a.split(";").map(i=>i.trim().split("=")).reduce((i,e)=>(i[e[0]]=e[1],i),{})}async function U(){let a=await L(p,{headers:{"user-agent":m}}).then(e=>e.headers.get("set-cookie"));return d(a).csrftoken}var k=class{constructor(i){i&&(this.session=i.session,this.csrf=i.csrf)}async init(i){return this.csrf=await U(),i&&(this.session=i),this}};import q from"events";var y=class extends q{constructor(e=1){super();this.space=e,this.used=0,this.releases=[]}async lock(){if(this.used>=this.space){let e=new Promise(t=>this.releases.push(t));this.emit("wait",{lock:e,release:this.releases[this.releases.length-1]}),await e}return this.used++,this.emit("lock"),this.used}unlock(){var e;return this.used<=0?0:(this.releases.length>0&&((e=this.releases.shift())==null||e()),this.used--,this.emit("unlock"),this.used<=0&&this.emit("all-clear"),this.used)}resize(e){var t;for(this.space=e;this.used<e&&this.releases.length>0;)(t=this.releases.shift())==null||t();return this.space}full(){return this.used>=this.space}waiting(){return this.releases.length}},b=class extends y{constructor({limit:e=20,interval:t=1e4,concurrent:s=2}={}){super(s);this.count=0;this.last=0;this.time_mutex=new y(e),this.interval=t,this.time_mutex.on("lock",(...r)=>this.emit("time-lock",...r)),this.time_mutex.on("unlock",(...r)=>this.emit("time-unlock",...r))}async lock(){return this.last+this.interval<Date.now()?this.reset():this.time_mutex.full()&&!this.timer&&this.cleaner(),await this.time_mutex.lock(),this.count++,super.lock()}reset(){for(;this.count>0;)this.time_mutex.unlock(),this.count--;this.last=Date.now(),this.emit("timer-reset")}cleaner(){this.timer=setTimeout(()=>{this.reset(),setTimeout(()=>{this.time_mutex.waiting()>0?this.cleaner():this.timer=void 0},0)},this.last+this.interval-Date.now())}set limit(e){this.time_mutex.resize(e)}};var x=class extends I{constructor(e=null,t=h){super();this.limiter=new b;let s;this.initialized=new Promise(r=>{s=r}),this.cache=t,e?(this.credential=e,setImmediate(()=>s())):(this.credential=new k,this.credential.init().then(()=>s()))}async user(e){await this.initialized;let{data:t}=await this.graphql({operationName:"getUserProfile",variables:{username:e},query:`
            query getUserProfile($username: String!) {
                allQuestionsCount {
                    difficulty
                    count
                }
                matchedUser(username: $username) {
                    username
                    socialAccounts
                    githubUrl
                    contributions {
                        points
                        questionCount
                        testcaseCount
                    }
                    profile {
                        realName
                        websites
                        countryName
                        skillTags
                        company
                        school
                        starRating
                        aboutMe
                        userAvatar
                        reputation
                        ranking
                    }
                    submissionCalendar
                    submitStats {
                        acSubmissionNum {
                            difficulty
                            count
                            submissions
                        }
                        totalSubmissionNum {
                            difficulty
                            count
                            submissions
                        }
                    }
                    badges {
                        id
                        displayName
                        icon
                        creationDate
                    }
                    upcomingBadges {
                        name
                        icon
                    }
                    activeBadge {
                        id
                    }
                }
                recentSubmissionList(username: $username, limit: 20) {
                    title
                    titleSlug
                    timestamp
                    statusDisplay
                    lang
                }
            }
            `});return t}async user_contest_info(e){await this.initialized;let{data:t}=await this.graphql({operationName:"userContestRankingInfo",variables:{username:e},query:`
            query userContestRankingInfo($username: String!) {
                userContestRanking(username: $username) {
                    attendedContestsCount
                    rating
                    globalRanking
                    totalParticipants
                    topPercentage
                    badge {
                        name
                    }
                }
                userContestRankingHistory(username: $username) {
                    attended
                    trendDirection
                    problemsSolved
                    totalProblems
                    finishTimeInSeconds
                    rating
                    ranking
                    contest {
                        title
                        startTime
                    }
                }
            }
            `});return t}async recent_submissions(e,t=20){await this.initialized;let{data:s}=await this.graphql({operationName:"getRecentSubmissionList",variables:{username:e,limit:t},query:`query getRecentSubmissionList($username: String!, $limit: Int) {
                recentSubmissionList(username: $username, limit: $limit) {
                    title
                    titleSlug
                    timestamp
                    statusDisplay
                    lang
                }
            }`});return s.recentSubmissionList||[]}async submissions({limit:e=20,offset:t=0,slug:s}={}){await this.initialized;let r=[],g=new Set,o=t;for(;r.length<e;){let{data:l}=await this.graphql({operationName:"Submissions",variables:{offset:o,limit:e-r.length>20?20:e-r.length,slug:s},query:`query Submissions($offset: Int!, $limit: Int!, $slug: String) {
                    submissionList(offset: $offset, limit: $limit, questionSlug: $slug) {
                        hasNext
                        submissions { id lang time timestamp statusDisplay runtime url isPending title memory titleSlug }
                    }
                }`});for(let n of l.submissionList.submissions)n.id=parseInt(n.id,10),n.timestamp=parseInt(n.timestamp,10)*1e3,n.isPending=n.isPending!=="Not Pending",n.runtime=parseInt(n.runtime,10)||0,n.memory=parseFloat(n.memory)||0,!g.has(n.id)&&(g.add(n.id),r.push(n));if(!l.submissionList.hasNext)break;o+=20}return r}async submission(e){var t;await this.initialized;try{await this.limiter.lock();let g=(t=(await(await R(`${p}/submissions/detail/${e}/`,{headers:{origin:p,referer:p,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"user-agent":m}})).text()).match(/var pageData = ({[^]+?});/))==null?void 0:t[1],o=new Function("return "+g)(),l={id:parseInt(o.submissionId),problem_id:parseInt(o.questionId),runtime:parseInt(o.runtime),runtime_distribution:o.runtimeDistributionFormatted?JSON.parse(o.runtimeDistributionFormatted).distribution.map(n=>[+n[0],n[1]]):[],runtime_percentile:0,memory:parseInt(o.memory),memory_distribution:o.memoryDistributionFormatted?JSON.parse(o.memoryDistributionFormatted).distribution.map(n=>[+n[0],n[1]]):[],memory_percentile:0,code:o.submissionCode,details:o.submissionData};return l.runtime_percentile=l.runtime_distribution.reduce((n,[S,C])=>n+(S>=l.runtime?C:0),0),l.memory_percentile=l.memory_distribution.reduce((n,[S,C])=>n+(S>=l.memory/1e3?C:0),0),this.limiter.unlock(),l}catch(s){throw this.limiter.unlock(),s}}async problems({category:e="",offset:t=0,limit:s=100,filters:r={}}={}){await this.initialized;let g={categorySlug:e,skip:t,limit:s,filters:r},{data:o}=await this.graphql({operationName:"problemsetQuestionList",variables:g,query:`query problemsetQuestionList($categorySlug: String, $limit: Int, $skip: Int, $filters: QuestionListFilterInput) {
                problemsetQuestionList: questionList( 
                    categorySlug: $categorySlug
                    limit: $limit
                    skip: $skip
                    filters: $filters
                ) {
                    total: totalNum
                    questions: data {
                        acRate 
                        difficulty 
                        freqBar 
                        questionFrontendId 
                        isFavor
                        isPaidOnly 
                        status 
                        title 
                        titleSlug 
                        topicTags { name id slug } 
                        hasSolution 
                        hasVideoSolution
                    }
                }
            }`});return o.problemsetQuestionList}async problem(e){await this.initialized;let{data:t}=await this.graphql({operationName:"questionData",variables:{titleSlug:e.toLowerCase().replace(/\s/g,"-")},query:`query questionData($titleSlug: String!) {
                question(titleSlug: $titleSlug) {
                  questionId
                  questionFrontendId
                  boundTopicId
                  title
                  titleSlug
                  content
                  translatedTitle
                  translatedContent
                  isPaidOnly
                  difficulty
                  likes
                  dislikes
                  isLiked
                  similarQuestions
                  exampleTestcases
                  contributors {
                    username
                    profileUrl
                    avatarUrl
                  }
                  topicTags {
                    name
                    slug
                    translatedName
                  }
                  companyTagStats
                  codeSnippets {
                    lang
                    langSlug
                    code
                  }
                  stats
                  hints
                  solution {
                    id
                    canSeeDetail
                    paidOnly
                    hasVideoSolution
                    paidOnlyVideo
                  }
                  status
                  sampleTestCase
                  metaData
                  judgerAvailable
                  judgeType
                  mysqlSchemas
                  enableRunCode
                  enableTestMode
                  enableDebugger
                  envInfo
                  libraryUrl
                  adminUrl
                  challengeQuestion {
                    id
                    date
                    incompleteChallengeCount
                    streakCount
                    type
                  }
                  note
                }
              }`});return t.question}async whoami(){await this.initialized;let{data:e}=await this.graphql({operationName:"globalData",variables:{},query:`query globalData {
                userStatus {
                  userId
                  username
                  avatar
                  isSignedIn
                  isMockUser
                  isPremium
                  isAdmin
                  isSuperuser
                  isTranslator
                  permissions
                }
              }`});return e.userStatus}async graphql(e){await this.initialized;try{await this.limiter.lock();let t=p,s=await R(`${t}/graphql`,{method:"POST",headers:{"content-type":"application/json",origin:t,referer:t,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"x-csrftoken":this.credential.csrf||"","user-agent":m},body:JSON.stringify(e)});if(this.emit("receive-graphql",s.clone()),s.headers.has("set-cookie")){let r=d(s.headers.get("set-cookie"));r.csrftoken&&(this.credential.csrf=r.csrftoken,this.emit("update-csrf",this.credential))}return this.limiter.unlock(),s.json()}catch(t){throw this.limiter.unlock(),t}}},_=x;import Q from"events";import E from"node-fetch";import N from"node-fetch";async function T(){let a=await N(f,{headers:{"user-agent":m}}).then(e=>e.headers.get("set-cookie"));return d(a).csrftoken}var v=class{constructor(i){i&&(this.session=i.session,this.csrf=i.csrf)}async init(i){return this.csrf=await T(),i&&(this.session=i),this}};var P=class extends Q{constructor(e=null,t=h){super();this.limiter=new b;let s;this.initialized=new Promise(r=>{s=r}),this.cache=t,e?(this.credential=e,setImmediate(()=>s())):(this.credential=new v,this.credential.init().then(()=>s()))}async user(e){await this.initialized;let{data:t}=await this.graphql({operationName:"getUserProfile",variables:{username:e},query:`
            query getUserProfile($username: String!) {
                userProfileUserQuestionProgress(userSlug: $username) {
                    numAcceptedQuestions { difficulty count }
                    numFailedQuestions { difficulty count }
                    numUntouchedQuestions { difficulty count }
                }
                userProfilePublicProfile(userSlug: $username) {
                    username haveFollowed siteRanking
                    profile { 
                        userSlug realName aboutMe userAvatar location gender websites skillTags contestCount asciiCode
                        medals { name year month category }
                        ranking { 
                            currentLocalRanking currentGlobalRanking currentRating totalLocalUsers totalGlobalUsers
                        }
                        socialAccounts { provider profileUrl }
                    }
                }
            }
            `});return t}async graphql(e){await this.initialized;try{await this.limiter.lock();let t=f,s=await E(`${t}/graphql`,{method:"POST",headers:{"content-type":"application/json",origin:t,referer:t,cookie:`csrftoken=${this.credential.csrf||""}; LEETCODE_SESSION=${this.credential.session||""};`,"x-csrftoken":this.credential.csrf||"","user-agent":m},body:JSON.stringify(e)});if(this.emit("receive-graphql",s.clone()),s.headers.has("set-cookie")){let r=d(s.headers.get("set-cookie"));r.csrftoken&&(this.credential.csrf=r.csrftoken,this.emit("update-csrf",this.credential))}return this.limiter.unlock(),s.json()}catch(t){throw this.limiter.unlock(),t}}},A=P;var ye=_;export{p as BASE_URL,f as BASE_URL_CN,w as Cache,k as Credential,_ as LeetCode,A as LeetCodeCN,y as Mutex,b as RateLimiter,m as USER_AGENT,h as cache,D as caches,ye as default};
